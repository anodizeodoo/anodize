<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id='l10n_mx_edi_report_payslip' inherit_id="hr_payroll.report_payslip">
        <xpath expr="//div[hasclass('page')]" position="before">
            <t t-set="company" t-value="o.company_id or o.contract_id.company_id"/>
<!--            <t t-if="not o.l10n_mx_cfdi_uuid and o.l10n_mx_edi_is_required()">-->
<!--                <div class="btn btn-danger">-->
<!--                    <h1>A signature of this payment is required, but it is not signed.</h1>-->
<!--                </div>-->
<!--            </t>-->
            <t t-if="o.l10n_mx_cfdi_uuid">
                <!--New global variables-->
                <t t-set="xml" t-value="o.l10n_mx_edi_get_xml_etree()"/>
                <t t-set="tfd" t-value="o.l10n_mx_edi_get_tfd_etree(xml)"/>
                <t t-set="payroll" t-value="o.l10n_mx_edi_get_payroll_etree(xml)"/>
                <t t-set="tfd_original_string" t-value="o._get_l10n_mx_edi_cadena()"/>
            </t>
        </xpath>
        <xpath expr="//div[hasclass('page')]/table[1]" position="replace">
            <div>
                <h3>Emisor</h3>
            </div>
            <div class="row">
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>RFC Emisor:</strong>
                        <span t-esc="company.vat"/>
                    </p>
                    <p class="m-0">
                        <strong>Nombre del Emisor:</strong>
                        <span t-esc="company.name"/>
                    </p>
                    <p class="m-0">
                        <strong>CURP:</strong>
                        <span t-esc="company.partner_id.l10n_mx_edi_curp"/>
                    </p>
                    <p class="m-0">
                        <strong>Registro Patronal:</strong>
                        <span t-esc="company.l10n_mx_edi_employer_registration_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>Régimen fiscal emisor:</strong>
                        <span t-esc="dict(company._fields['l10n_mx_edi_fiscal_regime'].selection)[company.l10n_mx_edi_fiscal_regime]"> </span>
                    </p>
                </div>
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>Folio fiscal:</strong>
                        <span t-esc="o.number.split('/')[1]"/>
                    </p>
                    <p class="m-0">
                        <strong>No. serie del CSD:</strong>
                        <span t-esc="company.l10n_mx_edi_certificate_ids.get_valid_certificate().serial_number"/>
                    </p>
                    <p class="m-0">
                        <strong>Lugar fecha y hora de emisor:</strong>
                        <span t-esc="company.partner_id.zip"/>
                    </p>
                    <p class="m-0">
                        <strong>Efecto del comprobante:</strong>
                        <span>Nómina</span>
                    </p>
                </div>
            </div>
            <hr width="100%" style="background-color:rgb(204,204,204);border:medium none;clear:both;display:block;font-size:0px;min-height:1px;line-height:0; margin:16px 0px 16px 0px;"/>
            <div>
                <h3>Receptor</h3>
            </div>
            <div class="row">
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>RFC Receptor:</strong>
                        <span t-esc="o.employee_id.l10n_mx_edi_rfc"/>
                    </p>
                    <p class="m-0">
                        <strong>Nombre del Receptor:</strong>
                        <span t-esc="o.employee_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>No. Empleado:</strong>
                        <span t-esc="o.employee_id.id"/>
                    </p>
                    <p class="m-0">
                        <strong>Riesgo puesto:</strong>
                        <span t-esc="o.employee_id.l10n_mx_edi_risk_rank.code"/>
                    </p>
                    <p class="m-0">
                        <strong>Fecha de inicio de relación laboral:</strong>
                        <span t-esc="o.contract_id.date_start"/>
                    </p>
                    <p class="m-0">
                        <strong>Régimen de contratación:</strong>
                        <span t-esc="o.employee_id.l10n_mx_edi_contract_regime_type_id.code"/> <span t-esc="o.employee_id.l10n_mx_edi_contract_regime_type_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>Código Postal del Receptor:</strong>
                        <span t-esc="o.employee_id.address_home_id.zip"/>
                    </p>
                    <p class="m-0">
                        <strong>Régime fiscal del Receptor:</strong>
                        <span t-esc="o.employee_id.l10n_mx_edi_contract_regime_type_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>Tipo de jornada:</strong>
                        <span t-esc="o.employee_id.category_ids.name"/>
                    </p>
                </div>
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>Clave Entidad federativa:</strong>
                        <span t-esc="o.employee_id.address_home_id.state_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>Uso del CFDI:</strong>
                        <span>Nómina</span>
                    </p>
                    <p class="m-0">
                        <strong>No. de Seguridad Social:</strong>
                        <span t-esc="o.employee_id.ssnid"/>
                    </p>
                    <p class="m-0">
                        <strong>CURP:</strong>
                        <span t-esc="o.employee_id.l10n_mx_edi_curp"/>
                    </p>
                    <p class="m-0">
                        <strong>Antiguedad:</strong>
                        <span t-esc="'P%sW' % int(o.contract_id.get_seniority(date_to=o.date_to)['days'] / 7)"/>
                    </p>
                    <p class="m-0">
                        <strong>Tipo contrato:</strong>
                        <span t-esc="o.contract_id.l10n_mx_payroll_contract_type_id.name"/>
                    </p>
                    <p class="m-0">
                        <strong>Periocidad de pago:</strong>
                        <span t-esc="o.contract_id.l10n_mx_payroll_schedule_pay_id.name"> </span>
                    </p>
                    <p class="m-0">
                        <strong>Salario diario:</strong>
                        <span t-esc="float(o.contract_id.l10n_mx_payroll_integrated_salary)"
                                t-esc-options='{"widget": "monetary", "display_currency": company.currency_id}'/>
                    </p>
                    <p class="m-0">
                        <strong>Sindicalizado:</strong>
                        <span t-esc="'Sí' if o.employee_id.l10n_mx_edi_syndicated else 'No'"/>
                    </p>
                </div>
            </div>
            <hr width="100%" style="background-color:rgb(204,204,204);border:medium none;clear:both;display:block;font-size:0px;min-height:1px;line-height:0; margin:16px 0px 16px 0px;"/>
            <div>
                <h3>Complemento versión 1.2</h3>
            </div>
            <div class="row">
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>Tipo nómina:</strong>
                        <span>Nómina Ordinaria</span>
                    </p>
                    <p class="m-0">
                        <strong>Fecha pago:</strong>
                        <span t-esc="o.l10n_mx_payment_date"/>
                    </p>
                    <p class="m-0">
                        <strong>Fecha inicial de pago:</strong>
                        <span t-esc="o.date_from"/>
                    </p>
                    <p class="m-0">
                        <strong>Banco:</strong>
                        <span t-esc="o.employee_id.bank_account_id.bank_id.name"/>
                    </p>
                </div>
                <div class="col-6 text-left">
                    <p class="m-0">
                        <strong>Moneda:</strong>
                        <span t-esc="o.currency_id.name"/>
                    </p>
                     <p class="m-0">
                        <strong>No. de días pagados:</strong>
                       <span t-esc="int(sum(o.worked_days_line_ids.mapped('number_of_days')))"/>
                    </p>
                    <p class="m-0">
                        <strong>Método de pago:</strong>
                        <span t-if="o.employee_id.l10n_mx_payment_method" t-esc="dict(o.employee_id._fields['l10n_mx_payment_method'].selection)[o.employee_id.l10n_mx_payment_method]"/>
                    </p>
                    <p class="m-0">
                        <strong>Cuenta Bancaria:</strong>
                        <span t-esc="o.employee_id.bank_account_id.acc_number"/>
                    </p>
                </div>
            </div>
        </xpath>

        <xpath expr="//div[hasclass('page')]/table[2]" position="replace">
            <div>
                <h3>Conceptos</h3>
            </div>
            <table class="table table-condensed">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Quantity/rate</th>
                        <th>Amount</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr t-foreach="o.line_ids.filtered(lambda line: line.appears_on_payslip)" t-as="line">
                        <td><span t-field="line.code"/></td>
                        <td><span t-field="line.name"/></td>
                        <td><span t-field="line.quantity"/></td>
                        <td><span t-esc="line.amount"
                              t-esc-options='{"widget": "monetary", "display_currency": company.currency_id}'/></td>
                        <td><span t-esc="line.total"
                            t-esc-options='{"widget": "monetary", "display_currency": company.currency_id}'/></td>
                    </tr>
                </tbody>
            </table>
            <hr width="100%" style="background-color:rgb(204,204,204);border:medium none;clear:both;display:block;font-size:0px;min-height:1px;line-height:0; margin:16px 0px 16px 0px;"/>
            <div>
                <h3>Percepciones</h3>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th  style="width: 30%;">Tipo de percepción</th>
                        <th  style="width: 10%;">Clave</th>
                        <th  style="width: 30%;">Concepto</th>
                        <th  class="text-right" style="width: 15%;">Importe Gravado</th>
                        <th  class="text-right" style="width: 15%;">Importe Exento</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="o.get_cfdi_perceptions_data()['perceptions']" t-as="perception">
                        <tr>
                            <td><span t-esc="perception.name"/></td>
                            <td><span t-esc="perception.code"/></td>
                            <td><span t-esc="perception.name"/></td>
                            <td class="text-right"><span t-esc="perception.total if perception.category_id == o.get_cfdi_perceptions_data()['category_taxed'] else 0.0"/></td>
                            <td class="text-right"><span t-esc="perception.total if perception.category_id == o.get_cfdi_perceptions_data()['category_exempt'] else 0.0"/></td>
                        </tr>
                    </t>
                </tbody>
            </table>
            <div>
                <h3>Total Percepciones</h3>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th style="width: 70%;">Total sueldos</th>
                        <th class="text-right" style="width: 15%;">Total Exento</th>
                        <th class="text-right" style="width: 15%;">Total Gravado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span t-esc="o.get_cfdi_perceptions_data()['total_salaries']"/></td>
                        <td class="text-right"><span t-esc="o.get_cfdi_perceptions_data()['total_exempt']"/></td>
                        <td class="text-right"><span t-esc="o.get_cfdi_perceptions_data()['total_taxed']"/></td>
                    </tr>
                </tbody>
            </table>
            <hr width="100%" style="background-color:rgb(204,204,204);border:medium none;clear:both;display:block;font-size:0px;min-height:1px;line-height:0; margin:16px 0px 16px 0px;"/>
            <div>
                <h3>Deducciones</h3>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th  style="width: 35%;">Tipo de deducción</th>
                        <th  style="width: 15%;">Clave</th>
                        <th  style="width: 35%;">Concepto</th>
                        <th  class="text-right" style="width: 15%;">Importe</th>
                    </tr>
                </thead>
                <tbody>
                    <t t-foreach="o.get_cfdi_deductions_data()['deductions']" t-as="deduction">
                        <tr>
                            <td><span t-esc="deduction.name"/></td>
                            <td><span t-esc="deduction.code"/></td>
                            <td><span t-esc="deduction.name"/></td>
                            <td class="text-right"><span t-esc="'%.2f' % abs(deduction.total)"/></td>
                        </tr>
                    </t>
                </tbody>
            </table>
            <div>
                <h3>Total Deducciones</h3>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th  class="text-center"  style="width: 50%;">Total otras deducciones</th>
                        <th class="text-center" style="width: 55%;">Total impuestos retenidos</th>

                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-right"><span t-esc="o.get_cfdi_deductions_data()['total_other_deductions']"/></td>
                        <td class="text-right"><span t-esc="o.get_cfdi_deductions_data()['total_taxes_withheld']"/></td>
                    </tr>
                </tbody>
            </table>
            <hr width="100%" style="background-color:rgb(204,204,204);border:medium none;clear:both;display:block;font-size:0px;min-height:1px;line-height:0; margin:16px 0px 16px 0px;"/>
            <div>
                <h3>Totales Nómina</h3>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th class="text-center"  style="width: 50%;">Total percepciones</th>
                        <th class="text-center" style="width: 55%;">Total otros pagos</th>
                        <th class="text-center" style="width: 55%;">Total deducciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-right"><span t-esc="o.get_cfdi_perceptions_data()['total_perceptions']"/></td>
                        <td class="text-right"><span t-esc="o.get_cfdi_other_payments_data()['total_other']"/></td>
                        <td class="text-right"><span t-esc="'%.2f' % o.get_cfdi_deductions_data()['total_deductions']"/></td>
                    </tr>
                </tbody>
            </table>
            <t t-if="o.l10n_mx_cfdi_uuid">
                <div class="row" id='complement'>
                    <div class="barcode col-3">
                        <t t-set="sello" t-value="xml.get('Sello', 'No identificado')[-8:]"/>
                        <img alt="Barcode" t-att-src="'/report/barcode/?type=QR&amp;value=%s&amp;width=180&amp;height=180' % quote_plus(
                            'https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?' + keep_query(
                                re=o.l10n_mx_cfdi_supplier_rfc, rr=o.l10n_mx_cfdi_customer_rfc,
                                tt=0, id=o.l10n_mx_cfdi_uuid)
                                + '&amp;fe=%s' % quote_plus(
                                    sello, 'utf-8', 'strict', '=/').replace('%2B', '+'))"/>
                    </div>
                    <div class="complement-details col-9">
                        <div class="digital-stamp">
                            <span>Digital stamp of the emitter</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span t-esc="xml.get('Sello', 'No identificado')"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Digital stamp SAT</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span t-esc="tfd.get('SelloSAT', 'No identificado')"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Original chain complement of digital certification SAT</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span class="nowrap" t-esc="tfd_original_string"/>
                        </div>
                        <div t-if="xml.Emisor.xpath('cfdi:ExpedidoEn', namespaces=xml.nsmap)" class="digital-stamp">
                            <span>Issued from</span>
                        </div>
                        <div t-if="xml.Emisor.xpath('cfdi:ExpedidoEn', namespaces=xml.nsmap)" class="digital-stamp-content">
                            <span t-esc="xml.get('LugarExpedicion', 'No identificado')"/>
                        </div>
                        <div class="digital-stamp">
                            <span>Extra Info</span>
                        </div>
                        <div class="digital-stamp-content">
                            <span>Emitter certificate:</span> <span t-esc="xml.get('NoCertificado')"/>
                            <span> | Expedition place:</span> <span t-esc="xml.get('LugarExpedicion')"/>
                            <span> | Fiscal Regime:</span> <span t-esc="xml.Emisor.get('RegimenFiscal', '')"/>
                            <span> | Emission Date:</span> <span t-esc="xml.get('Fecha', '').replace('T', ' ')"/>
                            <span> | Certification Date:</span> <span t-esc="tfd.get('FechaTimbrado', '').replace('T', ' ')"/>
                            <span> | Fiscal Folio:</span> <span t-esc="tfd.get('UUID', '')"/>
                            <span> | Employer registration:</span> <span t-esc="payroll.Emisor.get('RegistroPatronal', 'NA')"/>
                            <span> | Bank:</span> <span t-esc="payroll.Receptor.get('Banco', 'NA')"/>
                        </div>
                        <div class="digital-stamp-content text-center">
                            <strong>This document is a printed representation of a CFDI</strong>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[hasclass('page')]/p[hasclass('text-center')]" position="replace"/>
        <xpath expr="//p[contains(@t-if, 'o.net_wage')]" position="replace"/>
        <xpath expr="//h2[@t-field='o.name']" position="replace"/>
        <xpath expr="//div[hasclass('page')]/div[@id='total']" position="replace"/>
        <xpath expr="//div[hasclass('page')]/table[1]" position="replace"/>
    </template>

</odoo>
