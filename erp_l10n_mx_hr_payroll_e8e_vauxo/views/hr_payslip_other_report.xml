<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="external_layout_standard_inherit" inherit_id="web.external_layout_standard">
        <xpath expr="//div[3]" position="attributes">
            <attribute name="t-if">o and o._name != 'hr.payslip'</attribute>
<!--            <t t-if="o and o._name != 'hr.payslip'">-->
<!--                <div class="row">-->
<!--                    <div class="col-6" name="company_address">-->
<!--                        <div t-field="company.partner_id"-->
<!--                            t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": true}'-->
<!--                        />-->
<!--                    </div>-->
<!--                </div>-->
<!--            </t>-->
        </xpath>
    </template> 

    <template id='l10n_mx_edi_report_payslip_other'>
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-set="o" t-value="o.with_context(lang=o.env.lang)"/>
                <t t-if="o.l10n_mx_cfdi_uuid">
                <!--New global variables-->
                    <t t-set="xml" t-value="o.l10n_mx_edi_get_xml_etree()"/>
                    <t t-set="tfd" t-value="o.l10n_mx_edi_get_tfd_etree(xml)"/>
                    <t t-set="payroll" t-value="o.l10n_mx_edi_get_payroll_etree(xml)"/>
                    <t t-set="tfd_original_string" t-value="o._get_l10n_mx_edi_cadena()"/>
                </t>
                <div class="page" style="font-size: 12px">
                    <div class="row" style="font-size: 16px">
                        <div class="col-12">
                            <p class="m-0">
                                <strong><span class="text-uppercase" t-esc="o.sudo().company_id.name"/></strong>
                            </p>
                        </div>
                    </div>
                    <div class="row" style="background-color: rgb(211, 211, 211); padding: 10px; border-radius: 1em">
                        <div class="col-4">
                            <p class="m-0">
                                <strong>RFC:</strong>
                                <span t-field="o.sudo().company_id.vat"/>
                            </p>
                            <p class="m-0">
                                <strong>Reg Pat:</strong>
                                <span t-field="o.sudo().employee_id.l10n_mx_edi_employer_registration_id.name"/>
                            </p>
                            <p class="m-0">
                                <strong>Reg Fiscal:</strong>
                                <span t-field="o.sudo().company_id.l10n_mx_edi_fiscal_regime"/>
                            </p>
                            <p class="m-0">
                                <strong>Expedition place: </strong>
                                <span t-field="o.sudo().company_id.zip"/> <span t-field="o.sudo().company_id.state_id.name"/>
                            </p>
                        </div>
                        <div class="col-4">
                             <p class="m-0">
                                <strong>Payslip type:</strong>
                                <span t-field="o.sudo().l10n_mx_payslip_type"/>
                            </p>
                        </div>
                        <div class="col-4">
                            <p class="m-0">
                                <strong><span t-field="o.sudo().number"/></strong>
                            </p>
                            <p class="m-0">
                                <strong>Date:</strong>
                                <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%d/%m/%Y')"/>
                            </p>
                            <p class="m-0">
                                <strong>Hour:</strong>
                                <span t-esc="context_timestamp(datetime.datetime.now()).strftime('%H:%M:%S')"/>
                            </p>
                        </div>
                    </div>

                    <div class="row" style="margin-top:5px;border-bottom: 1px solid grey;">
                        <div class="col-4" >
                            <p class="m-0" >
                                <strong><span t-field="o.sudo().employee_id"/></strong>
                            </p>
                            <p class="m-0">
                                <strong>Job:</strong>
                                <span t-field="o.sudo().contract_id.job_id"/>
                            </p>
                            <p class="m-0">
                                <strong>Dpto:</strong>
                                <span t-field="o.sudo().contract_id.department_id"/>
                            </p>
                            <p class="m-0">
                                <strong>RFC:</strong>
                                <span t-field="o.sudo().employee_id.l10n_mx_edi_rfc"/>
                            </p>
                            <p class="m-0">
                                <strong>CURP:</strong>
                                <span t-field="o.sudo().employee_id.l10n_mx_edi_curp"/>
                            </p>
                            <p class="m-0">
                                <strong>NSS:</strong>
                                <span t-field="o.sudo().employee_id.ssnid"/>
                            </p>
                            <p class="m-0">
                                <strong>Zip:</strong>
                                <span t-field="o.sudo().employee_id.zip"/>
                            </p>
                        </div>
                        <div class="col-4" >
                             <p class="m-0">
                                <strong>Start date Labor Relationship:</strong>
                                <span t-field="o.sudo().contract_id.date_start"/>
                            </p>
                            <p class="m-0">
                                <strong>Contract type:</strong>
                                <span t-field="o.sudo().contract_id.l10n_mx_payroll_contract_type_id.name"/>
                            </p>

                            <p class="m-0">
                                <strong>Type Regimen:</strong>
                                <span t-field="o.sudo().employee_id.l10n_mx_edi_contract_regime_type_id.name"/>
                            </p>
                            <p class="m-0">
                                <strong>Type of Salary:</strong>
                                <span t-field="o.sudo().contract_id.type_salary"/>
                            </p>
                         </div>
                        <div class="col-4" >
                            <!--<p class="m-0">
                                <strong>Exercise: <span t-esc="o.sudo().l10n_mx_payment_date.year"/></strong>
                            </p>-->
                            <p class="m-0">
                                <strong>Period:</strong>
<!--                                <span t-field="o.contract_id.structure_type_id.default_schedule_pay"/>-->
                                <t t-if="o.sudo().payslip_run_id">
                                    <span t-field="o.sudo().payslip_run_id.date_start"/>-<span t-field="o.sudo().payslip_run_id.date_end"/>
                                </t>
                                <t t-else="">
                                    <span t-field="o.sudo().date_from"/>-<span t-field="o.sudo().date_to"/>
                                </t>
                            </p>
                            <p class="m-0">
                                <strong>Pay days:</strong>
                                <span t-esc="sum(o.sudo().worked_days_line_ids.mapped('number_of_days'))"/>
                            </p>
                            <p class="m-0">
                                <strong>Payment date:</strong>
                                <span t-field="o.sudo().l10n_mx_payment_date"/>
                            </p>
                            <p class="m-0">
                                <strong>Working day:</strong>
                                <span t-field="o.sudo().employee_id.category_ids"/>
                            </p>
                            <p class="m-0">
                                <strong>SBC:</strong>
                                <span t-field="o.sudo().contract_id.l10n_mx_payroll_integrated_salary" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                            </p>
                            <p class="m-0">
                                <strong>SD:</strong>
                                <span t-field="o.sudo().contract_id.l10n_mx_payroll_daily_salary" t-options='{"widget": "monetary", "display_currency": o.company_id.currency_id}'/>
                            </p>
                        </div>
                    </div>

<!--                    <div class="row" style="background-color: rgb(211, 211, 211); margin-top:10px;">-->
<!--                        <div class="col-6 text-center" style="border: 2px solid black;">-->
<!--                            <strong>Perceptions</strong>-->
<!--                        </div>-->
<!--                        <div class="col-6 text-center" style="border: 2px solid black;">-->
<!--                            <strong>Deductions</strong>-->
<!--                        </div>-->
<!--                    </div>-->

                    <div class="row" style="margin-top:5px;">
                        <div class="col-6" >
                            <table  class="table table-sm" style="margin-top:3px;border-radius: 15px 15px 15px 15px;border-collapse: separate">
                                <thead>
                                    <tr style="background-color: rgb(211, 211, 211);color:black;">
                                        <th colspan="4" class="text-center" style="border-radius: 15px 15px 0px 0px;">Perceptions</th>
                                    </tr>
                                    <tr style="background-color: rgb(211, 211, 211);color:black;font-size:10px;">
                                        <th  style="width: 15%;">Clave int</th>
                                        <th  style="width: 15%;">Clave SAT</th>
                                        <th  style="width: 55%;">Concepto</th>
                                        <th  class="text-right" style="width: 15%;">Importe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="total_perception" t-value="0.00"/>
                                    <t t-if="o.l10n_mx_cfdi_uuid">
                                        <t t-foreach="o.get_cfdi_perceptions_data_xml()" t-as="perception">
                                            <tr>
                                                <td><span t-esc="perception['clave']"/></td>
                                                <td><span t-esc="perception['code']"/></td>
                                                <td><span t-esc="perception['concepto']"/></td>
                                                <td class="text-left">
                                                    <span t-esc="perception['total']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                    <t t-set="total_line" t-value="perception['total']"/>
                                                    <t t-set="total_perception" t-value="total_perception + total_line"/>
                                                </td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td colspan="3" class="text-center"><strong>Total Perceptions</strong></td>
                                            <td class="text-right"><span t-esc="total_perception" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                                    </tr>

                                    </t>
                                    <t t-else="">
                                        <t t-foreach="o.get_cfdi_perceptions_data()['perceptions']" t-as="perception">
                                            <tr>
                                                <td><span t-esc="perception.sudo().code"/></td>
                                                <td><span t-esc="perception.sudo().salary_rule_id.l10n_mx_sat_key_id.l10n_mx_sat_code"/></td>
                                                <td><span t-esc="perception.sudo().name"/></td>
                                                <td class="text-right">
                                                    <span t-esc="'%.2f'% perception.sudo().total"/>
                                                    <t t-set="total_perception" t-value="total_perception + perception.total"/>
                                                </td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td colspan="3" class="text-center"><strong>Total Perceptions</strong></td>
                                        <td class="text-right"><span t-esc="'%.2f'% total_perception"/></td>
                                    </tr>
                                    </t>

                                </tbody>
                            </table>
                        </div>
                        <div class="col-6" >
                            <table class="table table-sm" style="margin-top:3px;border-radius: 15px 15px 15px 15px;border-collapse: separate">
                                <thead>
                                    <tr style="background-color: rgb(211, 211, 211);color: black;">
                                        <th colspan="4" class="text-center" style="border-radius: 15px 15px 0px 0px;">Deductions</th>
                                    </tr>
                                    <tr style="background-color: rgb(211, 211, 211);color:black;font-size:10px;">
                                       <th  style="width: 15%;">Clave int</th>
                                        <th  style="width: 15%;">Clave SAT</th>
                                        <th  style="width: 55%;">Concepto</th>
                                        <th  class="text-left" style="width: 15%;">Importe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="total_deductions" t-value="0.00"/>
                                    <t t-if="o.l10n_mx_cfdi_uuid">
                                        <t t-foreach="o.get_cfdi_deductions_data_xml()" t-as="deduction">
                                            <tr>
                                                <td><span t-esc="deduction['clave']"/></td>
                                                <td><span t-esc="deduction['code']"/></td>
                                                <td><span t-esc="deduction['concepto']"/></td>
                                                <td class="text-left">
                                                    <span t-esc="deduction['importe']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                                    <t t-set="total_deductions" t-value="total_deductions + float('%.2f' % abs(deduction['importe']))"/>
                                                </td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td colspan="3" class="text-center"><strong>Total Perceptions</strong></td>
                                            <td class="text-right"><span t-esc="total_deductions" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/></td>
                                        </tr>
                                    </t>
                                    <t t-else="">
                                        <t t-foreach="o.get_cfdi_deductions_data()['deductions']" t-as="deduction">
                                            <tr>
                                                <td><span t-esc="deduction.code"/></td>
                                                <td><span t-esc="deduction.salary_rule_id.l10n_mx_sat_key_id.l10n_mx_sat_code"/></td>
                                                <td><span t-esc="deduction.name"/></td>
                                                <td class="text-right">
                                                    <span t-esc="'%.2f' % abs(deduction.total)"/>
<!--                                                <t t-set="total_deductions" t-value="total_deductions + float('%.2f' % abs(deduction.total))"/>-->
                                                </td>
                                            </tr>
                                        </t>
                                        <tr>
                                            <td colspan="3" class="text-center"><strong>Total Deductions</strong></td>
                                            <td class="text-right"><span t-esc="'%.2f' % abs(o.get_cfdi_deductions_data()['total_deductions'])"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row" style="margin-top:5px;">
                        <t t-if="o.l10n_mx_cfdi_uuid">
                            <t t-set="Total_dict" t-value="o.get_sat_total_deductions_data_xml()"/>
                        </t>
                        <div class="col-6" >

                        </div>
                        <div class="col-6 text-right">
                            <p class="m-0">
                                <strong>Subtotal </strong>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['subtotal']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                                <t t-else="">
                                    <span t-esc="subtotal" />
                                </t>
                            </p>
                            <p class="m-0">
                                <strong>Descuentos</strong>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['discount']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                                <t t-else="">
                                    <t t-set="discount" t-value="o.get_cfdi_deductions_data()['total_other_deductions'] if o.get_cfdi_deductions_data()['total_other_deductions'] else 0.00"/>
                                    <span t-esc="discount" />
                                </t>
                            </p>
                            <p class="m-0">
                                <strong>Retenciones</strong>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['totalimpuestosretenidos']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                                <t t-else="">
                                <t t-set="retention" t-value="o.get_cfdi_deductions_data()['total_taxes_withheld'] if o.get_cfdi_deductions_data()['total_taxes_withheld'] else 0.00"/>
                                <span t-esc="retention"/>
                                </t>
                            </p>
                            <p class="m-0">
                                <strong>Total </strong>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['total']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                    <t t-set="total" t-value="Total_dict[0]['total']"/>
                                </t>
                                <t t-else="">
                                <t t-set="total" t-value="sum(o.sudo().line_ids.filtered(lambda r: r.salary_rule_id.l10n_mx_sum_total).mapped('total'))"/>
                                <span t-esc="'%.2f' % total"/>
                                </t>
                            </p>
                            <p class="m-0">
                                <strong>Neto del recibo </strong>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['total']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                                <t t-else="">
                                <span t-esc="'%.2f' % total"/>
                                </t>
                            </p>
                        </div>
                    </div>
                    <div class="row" style="margin-top:5px;border-bottom:1px solid grey" >
                        <div class="col-6" >
                            <p class="m-0">
                                <strong>Total Perceptions plus other payments:</strong>
                                <t t-set="subtotal" t-value="float(o.get_cfdi_perceptions_data()['total_perceptions'] + o.get_cfdi_other_payments_data()['total_other'])"/>
                                <t t-if="o.l10n_mx_cfdi_uuid">
                                    <span t-esc="Total_dict[0]['subtotal']" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                                <t t-else="">
                                    <span t-esc="subtotal" t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
                                </t>
                            </p>
                        </div>
                    </div>
                    <div class="row" style="margin-top:5px;font-size:9px;">
                        <div class="col-12">
                            <p class="m-0">
                                <strong>Importe: </strong><span t-esc="o.amount_to_text(total)" style="color:grey" /> |
                                <strong>Método de pago: </strong><t t-if="o.sudo().l10n_mx_payment_method =='PUE'"><span style="color:grey">PUE</span></t><t t-if="o.sudo().l10n_mx_payment_method == 'PPD'"><span style="color:grey">PPD</span></t> |
                                <strong>Banco: </strong><span t-esc="o.bank_id.name" style="color:grey"/> |
                                <strong>Cuenta: </strong><span t-esc="o.bank_account_id.acc_number" style="color:grey"/> |
                                <strong>Forma de pago: </strong><span t-esc="o.l10n_mx_edi_payment_method_id.name" style="color:grey"/>

                           </p>
                        </div>
                    </div>

                    <div class="row" style="margin-top:3.5em;">
                        <div class="col-8 text-center">
                            <p class="m-0">
                                <span>Recibí pago del patrón  </span>
                                <span class="text-uppercase" t-esc="o.sudo().company_id.name"/>
                                <span>, la cantidad que ampara el presente recibo por concepto de salario, incluyendo en éste pago séptimos días y demás prestaciones legales a que tengo derecho, manifestando mi conformidad con los importes y conceptos descritos en el mismo, sin que por periodo que se ampara se me adeude cantidad alguna.</span>
                           </p>
                        </div>
                        <div class="col-4 text-center" style="font-size:10px;">
                            <div class="row">
                            </div>
                            <div class="row" style="padding-top:50px;margin-bottom:0px;">
                                 <div class="col-12">
                                     <span>_________________________________</span>
                                 </div>
                            </div>
                            <div class="row" style="padding:0px;margin-top:0px;">
                                <div class="col-12" style="padding:0px;margin-top:0px;">
                                    <span><strong>Firma del empleado</strong></span>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <t t-if="o.sudo().l10n_mx_cfdi_uuid and xml">
                        <div class="row" id='complement' style="margin-top:2em;font-size: 20px;" t-if="xml">
                            <div class="barcode col-3" t-if="xml">
                                <t t-set="sello" t-value="xml.get('Sello', 'No identificado')[-8:]"/>
                                <img alt="Barcode" t-att-src="'/report/barcode/?type=QR&amp;value=%s&amp;width=180&amp;height=180' % quote_plus(
                                    'https://verificacfdi.facturaelectronica.sat.gob.mx/default.aspx?' + keep_query(
                                        re=o.sudo().l10n_mx_cfdi_supplier_rfc, rr=o.sudo().l10n_mx_cfdi_customer_rfc,
                                        tt=0, id=o.sudo().l10n_mx_cfdi_uuid)
                                        + '&amp;fe=%s' % quote_plus(
                                            sello, 'utf-8', 'strict', '=/').replace('%2B', '+'))"/>
                            </div>
                            <div class="complement-details col-9" t-if="xml">
                                <div class="digital-stamp">
                                    <span>Digital stamp of the emitter</span>
                                </div>
                                <div class="digital-stamp-content">
                                    <span t-esc="xml.get('Sello', 'No identificado')"/>
                                </div>
                                <div class="digital-stamp">
                                    <span>Digital stamp SAT</span>
                                </div>
                                <div class="digital-stamp-content">
                                    <span t-esc="tfd.get('SelloSAT', 'No identificado')"/>
                                </div>
                                <div class="digital-stamp">
                                    <span>Original chain complement of digital certification SAT</span>
                                </div>
                                <div class="digital-stamp-content">
                                    <span class="nowrap" t-esc="tfd_original_string"/>
                                </div>
                                <div t-if="xml.Emisor.xpath('cfdi:ExpedidoEn', namespaces=xml.nsmap)" class="digital-stamp-content">
                                    <span t-esc="xml.get('LugarExpedicion', 'No identificado')"/>
                                </div>
                                <div class="digital-stamp">
                                    <span>Extra Info</span>
                                </div>
                                <div class="digital-stamp-content">
                                    <span>Emitter certificate:</span> <span t-esc="xml.get('NoCertificado')"/>
                                    <span> | Fiscal Regime:</span> <span t-esc="xml.Emisor.get('RegimenFiscal', '')"/>
                                    <span> | Certification Date:</span> <span t-esc="tfd.get('FechaTimbrado', '').replace('T', ' ')"/>
                                    <span> | Fiscal Folio:</span> <span t-esc="tfd.get('UUID', '')"/>
                                </div>
                                <div class="digital-stamp-content text-center" style="font-size:14px">
                                    <strong>This document is a printed representation of a CFDI</strong>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
            </t>
        </t>
    </template>

    <template id="report_payslip_other_lang">
        <t t-foreach="docs" t-as="o">
            <t t-call="erp_l10n_mx_hr_payroll_e8e_vauxo.l10n_mx_edi_report_payslip_other" t-lang="o.employee_id.sudo().address_home_id.lang"/>
        </t>
    </template>

</odoo>
